<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immunization Tracker - IA2030 Compliant</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading Immunization Tracker...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button id="menu-toggle" class="menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-syringe"></i>
                    <h1>Immunization Tracker</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="user-role-badge" class="role-badge"></span>
                    <span id="current-user"></span>
                </div>
                <button id="logout-btn" class="btn-icon" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
                <button id="install-btn" class="btn-primary hidden">
                    <i class="fas fa-download"></i> Install App
                </button>
                <div class="connection-status" id="connection-status">
                    <i class="fas fa-wifi"></i>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-user">
                <div class="user-avatar">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="user-details">
                    <h3 id="sidebar-username"></h3>
                    <p id="sidebar-facility"></p>
                </div>
            </div>

            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#register-child"><i class="fas fa-user-plus"></i> Register Child</a></li>
                <li><a href="#children-list"><i class="fas fa-child"></i> Children List</a></li>
                <li><a href="#vaccination"><i class="fas fa-syringe"></i> Vaccination</a></li>
                <li><a href="#reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#stock"><i class="fas fa-boxes"></i> Stock Management</a></li>
                <li><a href="#cold-chain"><i class="fas fa-temperature-low"></i> Cold Chain</a></li>
                <li class="admin-only"><a href="#admin"><i class="fas fa-cogs"></i> Admin Panel</a></li>
                <li><a href="#settings"><i class="fas fa-sliders-h"></i> Settings</a></li>
            </ul>

            <div class="sidebar-footer">
                <div class="sync-status">
                    <i class="fas fa-sync"></i>
                    <span id="sync-status-text">Synced</span>
                </div>
                <button id="offline-data" class="btn-small">
                    <i class="fas fa-database"></i> Offline Data
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view active">
                <div class="view-header">
                    <h2><i class="fas fa-home"></i> Dashboard</h2>
                    <div class="view-actions">
                        <button id="refresh-dashboard" class="btn-icon">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button id="download-dashboard" class="btn-primary">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <!-- Stats Cards -->
                    <div class="stat-card card-red">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="overdue-count">0</h3>
                            <p>Overdue Vaccinations</p>
                        </div>
                    </div>

                    <div class="stat-card card-yellow">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="due-soon-count">0</h3>
                            <p>Due This Week</p>
                        </div>
                    </div>

                    <div class="stat-card card-green">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="total-children">0</h3>
                            <p>Children Registered</p>
                        </div>
                    </div>

                    <div class="stat-card card-blue">
                        <div class="stat-icon">
                            <i class="fas fa-vial"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="vaccines-administered">0</h3>
                            <p>Vaccines Given</p>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="chart-container">
                        <div class="card">
                            <h3>Monthly Coverage</h3>
                            <canvas id="coverage-chart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="card">
                            <h3>Dropout Rates</h3>
                            <canvas id="dropout-chart"></canvas>
                        </div>
                    </div>

                    <!-- Defaulters List -->
                    <div class="table-container">
                        <div class="card">
                            <h3>Top Defaulters (7+ days overdue)</h3>
                            <div class="table-responsive">
                                <table id="defaulters-table">
                                    <thead>
                                        <tr>
                                            <th>Child ID</th>
                                            <th>Name</th>
                                            <th>Overdue Vaccine</th>
                                            <th>Days Overdue</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Alerts -->
                    <div class="card">
                        <h3><i class="fas fa-exclamation-triangle text-warning"></i> Low Stock Alerts</h3>
                        <div id="stock-alerts">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Register Child View -->
            <div id="register-child-view" class="view">
                <div class="view-header">
                    <h2><i class="fas fa-user-plus"></i> Register New Child</h2>
                </div>

                <div class="card">
                    <form id="child-registration-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="child-name">Full Name *</label>
                                <input type="text" id="child-name" required>
                            </div>
                            <div class="form-group">
                                <label for="child-dob">Date of Birth *</label>
                                <input type="date" id="child-dob" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="child-gender">Gender</label>
                                <select id="child-gender">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mother-name">Mother's Name</label>
                                <input type="text" id="mother-name">
                            </div>
                            <div class="form-group">
                                <label for="father-name">Father's Name</label>
                                <input type="text" id="father-name">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone-number">Phone Number</label>
                                <input type="tel" id="phone-number">
                            </div>
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" id="address">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="facility-code">Facility Code *</label>
                                <input type="text" id="facility-code" required>
                            </div>
                            <div class="form-group">
                                <label for="child-id">Child Immunization ID</label>
                                <input type="text" id="child-id" readonly>
                                <small>Auto-generated: FACILITYCODE-YEAR-UNIQUE</small>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Register Child
                            </button>
                            <button type="button" id="generate-schedule" class="btn-secondary">
                                <i class="fas fa-calendar-alt"></i> Generate Schedule
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Vaccine Schedule Preview -->
                <div id="schedule-preview" class="card hidden">
                    <h3>Vaccination Schedule</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Age</th>
                                    <th>Vaccine</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-body">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Children List View -->
            <div id="children-list-view" class="view">
                <div class="view-header">
                    <h2><i class="fas fa-child"></i> Children Registry</h2>
                    <div class="view-actions">
                        <input type="text" id="search-children" placeholder="Search by name or ID...">
                        <select id="filter-status">
                            <option value="all">All Status</option>
                            <option value="up-to-date">Up to Date</option>
                            <option value="overdue">Overdue</option>
                            <option value="due-soon">Due Soon</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <div class="card">
                        <div class="table-responsive">
                            <table id="children-table">
                                <thead>
                                    <tr>
                                        <th>Child ID</th>
                                        <th>Name</th>
                                        <th>Age</th>
                                        <th>Last Vaccine</th>
                                        <th>Next Due</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <div class="pagination">
                                <button id="prev-page" class="btn-icon"><i class="fas fa-chevron-left"></i></button>
                                <span id="page-info">Page 1 of 1</span>
                                <button id="next-page" class="btn-icon"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vaccination View -->
            <div id="vaccination-view" class="view">
                <div class="view-header">
                    <h2><i class="fas fa-syringe"></i> Vaccination Management</h2>
                </div>

                <div class="card">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="record-vaccine">Record Vaccination</button>
                        <button class="tab-btn" data-tab="view-schedule">View Schedule</button>
                        <button class="tab-btn" data-tab="batch-update">Batch Update</button>
                    </div>

                    <div id="record-vaccine" class="tab-content active">
                        <form id="vaccination-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="select-child">Select Child *</label>
                                    <select id="select-child" required>
                                        <option value="">Select a child...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="vaccine-type">Vaccine *</label>
                                    <select id="vaccine-type" required>
                                        <option value="">Select vaccine...</option>
                                        <!-- Vaccines will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="vaccine-date">Date Administered *</label>
                                    <input type="date" id="vaccine-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="vaccine-batch">Batch Number</label>
                                    <input type="text" id="vaccine-batch">
                                </div>
                                <div class="form-group">
                                    <label for="vaccinator">Vaccinator Name</label>
                                    <input type="text" id="vaccinator">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="vaccine-notes">Notes</label>
                                <textarea id="vaccine-notes" rows="3"></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Record Vaccination
                                </button>
                                <button type="button" id="mark-missed" class="btn-warning">
                                    <i class="fas fa-times"></i> Mark as Missed
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="view-schedule" class="tab-content">
                        <div class="schedule-container">
                            <!-- IA2030 Full Schedule -->
                            <div class="schedule-timeline">
                                <!-- Timeline will be generated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports-view" class="view">
                <div class="view-header">
                    <h2><i class="fas fa-chart-bar"></i> Reports & Analytics</h2>
                    <div class="view-actions">
                        <select id="report-period">
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <button id="generate-report" class="btn-primary">
                            <i class="fas fa-chart-line"></i> Generate
                        </button>
                        <button id="export-pdf" class="btn-secondary">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button id="export-csv" class="btn-secondary">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                    </div>
                </div>

                <div class="reports-grid">
                    <div class="card">
                        <h3>Coverage Report</h3>
                        <canvas id="coverage-report-chart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Dropout Analysis</h3>
                        <canvas id="dropout-report-chart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Stock Usage</h3>
                        <canvas id="stock-usage-chart"></canvas>
                    </div>
                    <div class="card">
                        <h3>Performance Metrics</h3>
                        <div id="performance-metrics">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Detailed Report</h3>
                    <div class="table-responsive">
                        <table id="detailed-report-table">
                            <thead>
                                <tr>
                                    <th>Antigen</th>
                                    <th>Target</th>
                                    <th>Administered</th>
                                    <th>Coverage %</th>
                                    <th>Dropout Rate</th>
                                    <th>Wastage %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Management View -->
            <div id="stock-view" class="view">
                <div class="view-header">
                    <h2><i class="fas fa-boxes"></i> Stock Management</h2>
                    <div class="view-actions">
                        <button id="add-stock" class="btn-primary">
                            <i class="fas fa-plus"></i> Add Stock
                        </button>
                        <button id="adjust-stock" class="btn-secondary">
                            <i class="fas fa-exchange-alt"></i> Adjust
                        </button>
                    </div>
                </div>

                <div class="stock-grid">
                    <div class="card">
                        <h3>Current Inventory</h3>
                        <div class="table-responsive">
                            <table id="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Vaccine</th>
                                        <th>Batch No.</th>
                                        <th>Expiry Date</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Stock Alerts</h3>
                        <div id="stock-warnings">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Stock Movement Log</h3>
                    <div class="table-responsive">
                        <table id="stock-log-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Vaccine</th>
                                    <th>Batch</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Balance</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Panel View -->
            <div id="admin-view" class="view admin-only">
                <div class="view-header">
                    <h2><i class="fas fa-cogs"></i> Admin Panel</h2>
                </div>

                <div class="admin-tabs">
                    <div class="tab-buttons">
                        <button class="admin-tab-btn active" data-tab="users">Users</button>
                        <button class="admin-tab-btn" data-tab="facilities">Facilities</button>
                        <button class="admin-tab-btn" data-tab="vaccines">Vaccines</button>
                        <button class="admin-tab-btn" data-tab="settings">System Settings</button>
                    </div>

                    <div id="users-tab" class="admin-tab-content active">
                        <!-- Users management content -->
                    </div>

                    <div id="facilities-tab" class="admin-tab-content">
                        <!-- Facilities management content -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Notifications -->
        <div id="notification-container"></div>

        <!-- Login Modal -->
        <div id="login-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-shield"></i> Immunization Tracker Login</h2>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <div id="login-error" class="error-message hidden"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <button type="button" id="register-link" class="btn-secondary">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Registration Modal -->
        <div id="register-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> New User Registration</h2>
                </div>
                <form id="register-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reg-name">Full Name *</label>
                            <input type="text" id="reg-name" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-email">Email *</label>
                            <input type="email" id="reg-email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reg-password">Password *</label>
                            <input type="password" id="reg-password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="reg-confirm">Confirm Password *</label>
                            <input type="password" id="reg-confirm" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reg-phone">Phone Number</label>
                            <input type="tel" id="reg-phone">
                        </div>
                        <div class="form-group">
                            <label for="reg-role">Role *</label>
                            <select id="reg-role" required>
                                <option value="user">Health Worker</option>
                                <option value="admin">Facility Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reg-facilities">Facilities (Multiple Selection)</label>
                        <select id="reg-facilities" multiple>
                            <!-- Facilities will be loaded dynamically -->
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple facilities</small>
                    </div>
                    <div id="register-error" class="error-message hidden"></div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                        <button type="button" id="back-to-login" class="btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc, 
            query, 
            where, 
            orderBy,
            serverTimestamp,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAo0KbHGOoPUYwIeM4S4DGtzqySv7aZIr8",
            authDomain: "professional-tracker.firebaseapp.com",
            databaseURL: "https://professional-tracker-default-rtdb.firebaseio.com",
            projectId: "professional-tracker",
            storageBucket: "professional-tracker.firebasestorage.app",
            messagingSenderId: "996112988194",
            appId: "1:996112988194:web:c53689f17f1506732ab27b",
            measurementId: "G-S4X90DHRNY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => {
            console.error("Offline persistence failed: ", err);
        });

        // Make Firebase available globally
        window.firebase = { app, auth, db, getAuth, getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, serverTimestamp };
    </script>

    <script src="app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>